{% extends 'inventario/base.html' %}
{% load form_extras %}
{% block content %}
<div class="row justify-content-center mb-4">
  <div class="col-lg-10">
    <div class="card shadow-lg border-0 animate__animated animate__fadeIn">
      <div class="card-body p-4">
        <h3 class="fw-bold text-primary mb-4"><i class="fa-solid fa-sliders me-2"></i>Reporte personalizado</h3>
        <form method="get" class="row g-3 align-items-end mb-0">
          {% for field in form.visible_fields %}
            {% if field.name == 'precio_unitario_min' or field.name == 'precio_unitario_max' %}
              <div class="col-md-4 col-lg-3">
                <label class="form-label fw-semibold">{{ field.label }}</label>
                <input type="number" step="0.01" name="{{ field.name }}" value="{{ field.value }}" class="form-control" placeholder="Ej: 100.00">
                {% if field.help_text %}<div class="form-text">{{ field.help_text }}</div>{% endif %}
                {% for error in field.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
              </div>
            {% else %}
              <div class="col-md-4 col-lg-3">
                <label class="form-label fw-semibold">{{ field.label }}</label>
                {{ field|add_class:'form-control select2-filter' }}
                {% if field.help_text %}<div class="form-text">{{ field.help_text }}</div>{% endif %}
                {% for error in field.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
              </div>
            {% endif %}
          {% endfor %}
          <div class="col-12 col-md-2 d-grid gap-2">
            <button type="submit" class="btn btn-primary fw-bold mb-2"><i class="fa-solid fa-search me-2"></i>Filtrar</button>
            <a href="?" class="btn btn-outline-secondary fw-bold"><i class="fa-solid fa-eraser me-2"></i>Limpiar</a>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

{% if form.is_bound %}
<div class="row justify-content-center mb-4">
  <div class="col-lg-12">
    <div class="card shadow-lg border-0 animate__animated animate__fadeIn">
      <div class="card-body p-4">
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-4">
          <h4 class="fw-bold text-primary mb-0"><i class="fa-solid fa-table-list me-2"></i>Resultados</h4>
          <div class="d-flex gap-2 mt-3 mt-md-0">
            <a href="?{% for k,v in request.GET.items %}{% if k != 'export' %}{{k}}={{v|urlencode}}&{% endif %}{% endfor %}export=excel" class="btn btn-success btn-sm fw-bold px-4 shadow-sm"><i class="fa-solid fa-file-excel me-2"></i>Exportar a Excel</a>
            <a href="?{% for k,v in request.GET.items %}{% if k != 'export' %}{{k}}={{v|urlencode}}&{% endif %}{% endfor %}export=pdf" class="btn btn-danger btn-sm fw-bold px-4 shadow-sm"><i class="fa-solid fa-file-pdf me-2"></i>Exportar a PDF</a>
          </div>
        </div>
        <div class="table-responsive mb-4">
          <table class="table table-bordered table-striped table-hover align-middle" id="reporte-table">
            <thead class="table-primary">
              <tr>
                <th><i class="fa-solid fa-box"></i> Bien</th>
                <th><i class="fa-solid fa-layer-group"></i> Rubro</th>
                <th><i class="fa-solid fa-file-invoice"></i> Orden</th>
                <th><i class="fa-solid fa-truck"></i> Proveedor</th>
                {% if form.cleaned_data.tipo == 'entregados' %}
                  <th><i class="fa-solid fa-calendar-day"></i> Fecha</th>
                  <th><i class="fa-solid fa-clock"></i> Hora</th>
                  <th><i class="fa-solid fa-user"></i> √Årea/Persona</th>
                {% endif %}
                <th><i class="fa-solid fa-dollar-sign"></i> Precio unitario</th>
                <th><i class="fa-solid fa-sort-numeric-up"></i> Cantidad</th>
                <th><i class="fa-solid fa-money-bill-wave"></i> Precio total</th>
              </tr>
            </thead>
            <tbody>
              {% for row in resultados %}
              <tr class="reporte-row">
                <td>{{ row.bien }}</td>
                <td>{{ row.rubro }}</td>
                <td>{{ row.orden }}</td>
                <td>{{ row.proveedor }}</td>
                {% if form.cleaned_data.tipo == 'entregados' %}
                  <td>{{ row.fecha }}</td>
                  <td>{{ row.hora }}</td>
                  <td>{{ row.area_persona }}</td>
                {% endif %}
                <td>{{ row.precio_unitario }}</td>
                <td>{{ row.cantidad }}</td>
                <td>{{ row.precio_total }}</td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="10" class="text-center"><div class="alert alert-warning mb-0"><i class="fa-solid fa-circle-exclamation"></i> No hay resultados para los filtros seleccionados.</div></td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          <nav>
            <ul class="pagination flex-wrap justify-content-center" id="reporte-pagination"></ul>
          </nav>
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  if (window.jQuery && window.jQuery.fn.select2) {
    window.jQuery('.select2-filter').select2({
      width: '100%',
      theme: 'bootstrap-5',
      placeholder: 'Seleccione...',
      allowClear: true,
      language: 'es'
    });
  }
});
</script>
{% endblock %}
