{% extends 'inventario/base.html' %}
{% load static %}
{% block content %}
<div class="card mt-5 w-100">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h3 class="mb-0 fw-bold text-primary">
        <i class="fa-solid fa-edit me-2"></i>Editar Orden de Compra #{{ orden.numero }}
      </h3>
    </div>
    
    <form method="post">
        {% csrf_token %}
        
        {% if form.errors %}
          <div class="alert alert-danger">
            <strong>Errores en el formulario:</strong>
            <ul class="mb-0">
              {% for field, errors in form.errors.items %}
                {% for error in errors %}
                  <li>{{ field }}: {{ error }}</li>
                {% endfor %}
              {% endfor %}
            </ul>
          </div>
        {% endif %}
        
        <div class="row mb-4">
          <div class="col-md-3">
            <label class="form-label fw-semibold">{{ form.numero.label }}</label>
            {{ form.numero }}
            {% if form.numero.errors %}
              <div class="text-danger small">{{ form.numero.errors|striptags }}</div>
            {% endif %}
          </div>
          <div class="col-md-3">
            <label class="form-label fw-semibold">{{ form.fecha_inicio.label }}</label>
            {{ form.fecha_inicio }}
            {% if form.fecha_inicio.errors %}
              <div class="text-danger small">{{ form.fecha_inicio.errors|striptags }}</div>
            {% endif %}
          </div>
          <div class="col-md-3">
            <label class="form-label fw-semibold">{{ form.fecha_fin.label }}</label>
            <input type="date" name="fecha_fin" class="form-control" value="{{ form.initial.fecha_fin|default_if_none:'' }}">
            {% if form.fecha_fin.errors %}
              <div class="text-danger small">{{ form.fecha_fin.errors|striptags }}</div>
            {% endif %}
          </div>
          <div class="col-md-3">
            <label class="form-label fw-semibold">{{ form.proveedor.label }}</label>
            {{ form.proveedor }}
            {% if form.proveedor.errors %}
              <div class="text-danger small">{{ form.proveedor.errors|striptags }}</div>
            {% endif %}
          </div>
        </div>

        <h4 class="mb-3 fw-bold text-secondary">
          <i class="fa-solid fa-list me-2"></i>Bienes de la Orden
        </h4>
        
        {% if formset.non_form_errors %}
          <div class="alert alert-danger">{{ formset.non_form_errors }}</div>
        {% endif %}
        
        {{ formset.management_form }}
        <div class="table-responsive">
          <table class="table table-bordered table-striped" id="formset-table">
              <thead class="table-primary">
                  <tr>
                      <th>Renglón</th>
                      <th>Bien</th>
                      <th>Cantidad</th>
                      <th>Precio Unitario</th>
                      <th>Precio Total</th>
                      <th width="100">Eliminar</th>
                  </tr>
              </thead>
              <tbody id="formset-body">
                  {% for f in formset %}
                  <tr class="formset-row" data-form-index="{{ forloop.counter0 }}">
                      {% for hidden in f.hidden_fields %}{{ hidden }}{% endfor %}
                      <td>{{ f.renglon }}</td>
                      <td>{{ f.bien }}</td>
                      <td>{{ f.cantidad }}</td>
                      <td>{{ f.precio_unitario }}</td>
                      <td class="precio-total-cell fw-bold"></td>
                      <td class="text-center">{{ f.DELETE }}</td>
                  </tr>
                  {% endfor %}
              </tbody>
          </table>
        </div>
        
        <div class="mb-3">
          <button type="button" id="add-form" class="btn btn-outline-primary">
            <i class="fa-solid fa-plus me-2"></i>Agregar ítem
          </button>
        </div>

        <div class="d-flex justify-content-between align-items-center mt-4">
            <button type="submit" class="btn btn-success btn-lg px-5 fw-bold shadow">
                <i class="fa-solid fa-floppy-disk me-2"></i>Guardar Cambios
            </button>
            <a href="{% url 'orden_detalle' orden.id %}" class="btn btn-outline-secondary btn-lg px-4 fw-bold shadow-sm">
                <i class="fa-solid fa-times me-2"></i>Cancelar
            </a>
        </div>
    </form>
  </div>
</div>


{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
function inicializarSelect2Bien() {
  $('.select2-bien-orden').select2({
    width: '100%',
    theme: 'bootstrap-5',
    placeholder: 'Seleccione un bien',
    allowClear: true,
    language: 'es'
  });
}

$(document).ready(function() {
  inicializarSelect2Bien();

  // Calcular precio total inicial
  $('.formset-row').each(function() {
    let row = $(this);
    let cantidad = parseFloat(row.find('input[name*="cantidad"]').val()) || 0;
    let precio = parseFloat(row.find('input[name*="precio_unitario"]').val()) || 0;
    let total = cantidad * precio;
    row.find('.precio-total-cell').text('$' + total.toFixed(2));
  });

  // Agregar nueva fila vacía (solo una por click)
  $('#add-form').off('click').on('click', function() {
    let totalForms = $('#id_ordendecompraitem_set-TOTAL_FORMS');
    let formIdx = parseInt(totalForms.val());
    if (isNaN(formIdx) || formIdx < 0) {
      formIdx = 0;
    }
    let optionsHtml = $('#formset-body select.select2-bien-orden:first').html();
    optionsHtml = optionsHtml.replace(/selected(\s*=\s*"selected")?/gi, '');
    optionsHtml = '<option value="">Seleccione un bien</option>' + optionsHtml;
    let emptyRow = $(
      `<tr class="formset-row" data-form-index="${formIdx}">
        <td><input type="number" name="ordendecompraitem_set-${formIdx}-renglon" class="form-control" min="1"></td>
        <td><select name="ordendecompraitem_set-${formIdx}-bien" class="form-control select2-bien-orden">${optionsHtml}</select></td>
        <td><input type="number" name="ordendecompraitem_set-${formIdx}-cantidad" class="form-control" min="1"></td>
        <td><input type="number" name="ordendecompraitem_set-${formIdx}-precio_unitario" class="form-control" step="0.01" min="0"></td>
        <td class="precio-total-cell fw-bold"></td>
        <td class="text-center"><input type="checkbox" name="ordendecompraitem_set-${formIdx}-DELETE"></td>
      </tr>`
    );
    $('#formset-body').append(emptyRow);
    totalForms.val(formIdx + 1);
    inicializarSelect2Bien();
  });

  // Eliminar fila
  $(document).on('change', 'input[type=checkbox][name*="DELETE"]', function() {
    if ($(this).is(':checked')) {
      $(this).closest('.formset-row').fadeOut();
    } else {
      $(this).closest('.formset-row').fadeIn();
    }
  });

  // Calcular precio total cuando cambian cantidad o precio unitario
  $(document).on('input', 'input[name*="cantidad"], input[name*="precio_unitario"]', function() {
    let row = $(this).closest('.formset-row');
    let cantidad = parseFloat(row.find('input[name*="cantidad"]').val()) || 0;
    let precio = parseFloat(row.find('input[name*="precio_unitario"]').val()) || 0;
    let total = cantidad * precio;
    row.find('.precio-total-cell').text('$' + total.toFixed(2));
  });
});
</script>
{% endblock %}

{% endblock %}
