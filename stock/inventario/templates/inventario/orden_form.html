{% extends 'inventario/base.html' %}
{% block extra_head %}
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/@ttskch/select2-bootstrap4-theme@1.5.2/dist/select2-bootstrap4.min.css" rel="stylesheet" />
{% endblock %}
{% block content %}
<div class="row justify-content-center w-100">
  <div class="col-lg-12 col-xl-11">
    <div class="card shadow-lg border-0 mb-4 animate__animated animate__fadeIn">
      <div class="card-body p-5">
        <h2 class="mb-4 fw-bold text-primary">
          <i class="fa-solid fa-file-contract me-2"></i>{{ titulo }}
        </h2>
        <form method="post" autocomplete="off">
          {% csrf_token %}
          <div class="row g-4 mb-4">
            <div class="col-md-6 mb-3">
              <label class="form-label fw-semibold">{{ form.numero.label }}</label>
              {{ form.numero }}
              {% if form.numero.errors %}
                <div class="text-danger small">{{ form.numero.errors|striptags }}</div>
              {% endif %}
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label fw-semibold">{{ form.proveedor.label }}</label>
              {{ form.proveedor }}
              {% if form.proveedor.errors %}
                <div class="text-danger small">{{ form.proveedor.errors|striptags }}</div>
              {% endif %}
            </div>
            <div class="col-md-6 mb-3">
              <div class="row g-2">
                <div class="col-md-6">
                  <label class="form-label fw-semibold">{{ form.fecha_inicio.label }}</label>
                  {{ form.fecha_inicio }}
                  {% if form.fecha_inicio.errors %}
                    <div class="text-danger small">{{ form.fecha_inicio.errors|striptags }}</div>
                  {% endif %}
                </div>
                <div class="col-md-6">
                  <label class="form-label fw-semibold">{{ form.fecha_fin.label }}</label>
                  {{ form.fecha_fin }}
                  {% if form.fecha_fin.errors %}
                    <div class="text-danger small">{{ form.fecha_fin.errors|striptags }}</div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
          <div class="mb-4">
            <h4 class="fw-bold mb-3"><i class="fa-solid fa-list-check me-2 text-success"></i>Ítems de la orden</h4>
            <div class="table-responsive rounded-4 shadow-sm">
              {{ formset.management_form }}
              <table id="items-table" class="table table-striped align-middle mb-0" style="min-width: 950px;">
                <thead class="table-primary">
                  <tr>
                    {% for field in formset.empty_form.visible_fields %}
                      {% if field.name != 'DELETE' %}
                        <th style="white-space:nowrap;">{{ field.label }}</th>
                      {% endif %}
                    {% endfor %}
                    <th style="min-width:60px;text-align:center;">Eliminar</th>
                  </tr>
                </thead>
                <tbody>
                  {% for form in formset.forms %}
                    <tr class="item-form-row">
                      {% for field in form.visible_fields %}
                        {% if field.name != 'DELETE' %}
                          <td style="min-width:120px;vertical-align:middle;">{{ field }}</td>
                        {% endif %}
                      {% endfor %}
                      <td style="vertical-align:middle;text-align:center;min-width:60px;">
                        <button type="button" class="btn btn-outline-danger btn-sm delete-row" title="Eliminar">
                          <i class="fa-solid fa-trash"></i>
                        </button>
                        {{ form.DELETE.as_hidden }}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            <button type="button" id="add-row" class="btn btn-outline-primary mt-3 px-4 py-2 fw-semibold shadow-sm">
              <i class="fa-solid fa-plus me-1"></i>Agregar ítem
            </button>
            <a href="{% url agregar_bien_url %}" target="_blank" class="btn btn-secondary ms-2 mt-3 px-4 py-2 fw-semibold shadow-sm">
              <i class="fa-solid fa-box-open me-1"></i>Agregar nuevo bien
            </a>
          </div>
          <div class="d-flex justify-content-between align-items-center mt-4">
            <button type="submit" class="btn btn-success btn-lg px-5 fw-bold shadow">
              <i class="fa-solid fa-floppy-disk me-2"></i>Guardar
            </button>
            <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary btn-lg px-4 fw-bold shadow-sm d-flex align-items-center">
              <i class="fa-solid fa-arrow-left me-2"></i>Volver al panel
            </a>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="/static/inventario/mayusculas.js"></script>
<script src="/static/inventario/select2_bien.js"></script>
<script>
setInputsToUpperCase('form');
aplicarSelect2Bien();
// Unificar el botón de eliminar: siempre botón rojo, y marcar el DELETE oculto si existe
document.addEventListener('DOMContentLoaded', function() {
  const addRowBtn = document.getElementById('add-row');
  const table = document.getElementById('items-table').getElementsByTagName('tbody')[0];
  const totalForms = document.getElementById('id_items-TOTAL_FORMS');

  // Renderizar la fila vacía con clases y select2 igual que la primera
  const emptyRowHtml = `
    <td>{{ formset.empty_form.renglon }}</td>
    <td>{{ formset.empty_form.bien }}</td>
    <td>{{ formset.empty_form.cantidad }}</td>
    <td>{{ formset.empty_form.precio_unitario }}</td>
    <td style="vertical-align:middle;text-align:center;min-width:60px;">
      <button type="button" class="btn btn-outline-danger btn-sm delete-row" title="Eliminar">
        <i class="fa-solid fa-trash"></i>
      </button>
      {{ formset.empty_form.DELETE.as_hidden }}
    </td>
  `;

  addRowBtn.addEventListener('click', function() {
    const formNum = parseInt(totalForms.value);
    let rowHtml = emptyRowHtml.replace(/__prefix__/g, formNum);
    const tr = document.createElement('tr');
    tr.className = 'item-form-row';
    tr.innerHTML = rowHtml;
    table.appendChild(tr);
    totalForms.value = formNum + 1;
    // Agregar clases y select2 al nuevo select bien
    const bienSelect = tr.querySelector("select[name$='-bien']");
    if (bienSelect) {
      bienSelect.classList.add('bien-select', 'form-control');
      $(bienSelect).select2({
        width: '100%',
        theme: 'bootstrap-5',
        placeholder: 'Seleccione un bien',
        allowClear: true,
        language: 'es'
      });
    }
  });

  table.addEventListener('click', function(e) {
    if (e.target.closest('.delete-row')) {
      const row = e.target.closest('tr');
      // Si hay un input DELETE oculto, marcarlo y ocultar la fila
      const deleteInput = row.querySelector('input[type="checkbox"][name$="-DELETE"]');
      if (deleteInput) {
        deleteInput.checked = true;
        row.style.display = 'none';
      } else {
        row.remove();
        totalForms.value = table.querySelectorAll('.item-form-row').length;
      }
    }
  });
});
</script>
{% endblock %}
